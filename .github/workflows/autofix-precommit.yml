name: AutoFix PR with Comment Trigger

on:
  pull_request:
    types: [opened, synchronized, reopened]

jobs:
  autofix:
    name: Autofix Pull Request Linting Errors
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Check PR comment
        id: check_comment
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pullRequest = context.issue;
            if (!pullRequest) {
              console.log('Not a pull request. Skipping...');
              return { should_skip: true };
            }

            const comments = pullRequest.comments;
            if (!comments) {
              console.log('No comments found. Skipping...');
              return { should_skip: true };
            }

            return {
              should_skip: !comments.some(comment => comment.body.includes('/autofixme!'))
            };

      - uses: pre-commit-ci/lite-action@v1.0.2
        if: steps.check_comment.outputs.should_skip == 'false'

      - name: Commit and push autofixed changes (Optional)
        if: always()  # Uncomment to commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "Autofix linting errors"
          git push origin ${{ github.head_ref }}
